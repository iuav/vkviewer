var initConfiguration={mapOptions:{maxExtent:new OpenLayers.Bounds(640161.933,5958026.134,2661768.457,7817626.892),restrictedExtent:new OpenLayers.Bounds(640161.933,5958026.134,2661768.457,7817626.892),projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:900913"),units:"m",startPoint:new OpenLayers.LonLat(1528150,6630500)},mapnikOptions:{resolutions:[1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,
19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254,1.194328566789627],serverResolutions:[156543.03390625,78271.516953125,39135.7584765625,19567.87923828125,9783.939619140625,4891.9698095703125,2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254,1.194328566789627,0.5971642833948135]},timeParameter:{extent:null,time:null,wms:"http://194.95.145.43/mapcache",
wms_layer:"messtischblaetter",wfs:"http://194.95.145.43/cgi-bin/mtbows",layer:"Historische Messtischblaetter",featureType:"Historische_Messtischblaetter_WFS",featurePrefix:"ms",featureNS:"http://mapserver.gis.umn.edu/mapserver",geometryName:"boundingbox",serviceVersion:"1.0.0",maxFeatures:1E4,srsName:"EPSG:900913",maxResolution:305.74811309814453},georeference_grid:{wms:new OpenLayers.Layer.WMS("georeferencer_wms_1","http://194.95.145.43/cgi-bin/mtb_grid",{layers:"mtb_grid_puzzle",transparent:!0},
{isBaseLayer:!1,displayInLayerSwitcher:!0,singleTile:!0}),wfs:new OpenLayers.Protocol.WFS({url:"http://194.95.145.43/cgi-bin/mtb_grid",geometryName:"the_geom",featureNS:"http://mapserver.gis.umn.edu/mapserver",featurePrefix:"ms",featureType:"mtb_grid",srsName:"EPSG:3857",maxFeatures:1E3,version:"1.0.0"})},userid:""};VK2={Utils:{},Tools:{},Layer:{},Styles:{},Controller:{}};VK2.Utils={initializeFancyboxForClass:function(a){$("."+a).each(function(){$(this).fancybox({type:"iframe"})})},loadBaseMap:function(a,b,c){a=new OpenLayers.Map(a,b);c=new OpenLayers.Layer.OSM("Mapnik","",c);a.addLayers([c]);a.setCenter(b.startPoint,2);return a},setGenericOpenLayersPropertys:function(a){OpenLayers.IMAGE_RELOAD_ATTEMPTS=5;OpenLayers.ProxyHost=VK2.Utils.getHost(a)},jumptolonlat:function(a,b,c){b=(new OpenLayers.LonLat(b,c)).transform(new OpenLayers.Projection("EPSG:4326"),a.getProjectionObject());
a.setCenter(b,12);return!0},encode_utf8:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):(127<d&&2048>d?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&63|128))}return b},decode_utf8:function(a){for(var b="",c=0,d=c1=c2=0;c<a.length;)d=a.charCodeAt(c),128>d?(b+=String.fromCharCode(d),c++):191<d&&224>d?(c2=a.charCodeAt(c+1),b+=String.fromCharCode((d&
31)<<6|c2&63),c+=2):(c2=a.charCodeAt(c+1),c3=a.charCodeAt(c+2),b+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63),c+=3);return b},getAllUrlParams:function(){for(var a=window.location.search.substring(1).split("&"),b={},c=0;c<a.length;c++){var d=a[c].split("=");b[d[0]]=decodeURIComponent(d.slice(1).join("="))}return b},get_url_param:function(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");a=RegExp("[\\?&]"+a+"=([^&#]*)").exec(window.location.href);return null==a?"":a[1]},getHost:function(a){var b=
location.protocol+"//"+location.hostname+(location.port?":"+location.port:"");return"/"==a.charAt(0)?b+a:b+"/"+a},routeToTop:function(a){var b=document.createElement("a");b.href=a;b.target="_top";document.body.appendChild(b);b.click()},fixControlConflictsOnOLMap:function(a){"undefined"!=typeof a.handlers?a.handlers.feature.stopDown=!1:"undefined"!=typeof a.handler&&(a.handler.stopDown=!1,a.handler.stopUp=!1)},getDictionaryValues:function(a){list=[];for(var b in a)return list.push(a[b]),list},get_I18n_String:function(a){return lang_dictionary[a]}};VK2.Class=function(a){classObj=function(){this.initialize.apply(this,arguments)};for(var b in a)classObj.prototype[b]=a[b];classObj.prototype.initialize||(classObj.prototype.initialize=function(){});return classObj};VK2.Filter={getBoundingBoxFilter:function(a,b){return new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,value:a,projection:b})},getTimeFilter:function(a,b,c,d){return new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,value:a,projection:b}),new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO,
property:"time",value:d}),new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO,property:"time",value:c})]})]})}};VK2.Validation={isBlattnumber:function(a){var b=[],b=-1!==a.indexOf(":"),c=-1!==a.indexOf("_"),b=b?a.split(":"):c?a.split("_"):[];return 2==b.length?areNumbers=(areNumbers=(areNumbers=(areNumbers=(areNumbers=!0)&&this.isInt(b[0])?!0:!1)&&this.isInt(b[1])?!0:!1)&&3>=b[0].length?!0:!1)&&3>=b[1].length?!0:!1:!1},isInt:function(a){return isValideInteger=/^[0-9]+$/.test(a)}};VK2.Utils.Georef={getZoomifyUrl:function(a){return url=a.substring(0,a.lastIndexOf("/")+1)},createZoomifyLayer:function(a){var b=this.getZoomifyUrl(a.zoomify_prop);return new OpenLayers.Layer.Zoomify(a.layer,b,new OpenLayers.Size(a.zoomify_width,a.zoomify_height))},zommToBBoxFromWMSLayer:function(a,b,c){wmsParser=new OpenLayers.Format.WMSCapabilities.v1_1_1;wmsCapaRequest=b+"&VERSION=1.1.1&SERVICE=WMS&REQUEST=GetCapabilities";OpenLayers.Request.GET({url:wmsCapaRequest,success:function(b){b=wmsParser.read(b.responseText).capability;
for(var e=0,f=b.layers.length;e<f;e+=1){var g=b.layers[e];if(g.name===c){bbox_pure=g.bbox["EPSG:4314"];bbox=OpenLayers.Bounds.fromArray(bbox_pure.bbox);bbox_transformed=bbox.transform(new OpenLayers.Projection(bbox_pure.srs),a.getProjectionObject());a.zoomToExtent(bbox_transformed);break}}}})},loadValidationLayer:function(a,b){var c=null;try{c=new OpenLayers.Layer.WMS(b.layer_id,b.wms_url,{layers:b.layer_id,type:"png",format:"image/png",transparent:"true"},{isBaseLayer:!1,opacity:0.75,visibility:!0})}catch(d){c=
new OpenLayers.Layer.Image("Default MTB","mtb_default.jpg",new OpenLayers.Bounds(0,0,1797,2001),new OpenLayers.Size(1E3,1E3),{numZoomLevels:3})}a.addLayer(c)},initializeGeoreferencerMap:function(a,b){var c=this.createZoomifyLayer(b),d={units:"pixels",maxExtent:new OpenLayers.Bounds(0,0,b.zoomify_width,b.zoomify_height),maxResolution:Math.pow(2,c.numberOfTiers-1),numZoomLevels:10,controls:[new OpenLayers.Control.Navigation,new OpenLayers.Control.PanZoomBar({zoomWorldIcon:!0}),new OpenLayers.Control.Attribution]},
d=new OpenLayers.Map(a,d);d.addLayer(c);d.zoomToMaxExtent();return d},initializeGeoreferenceResultMap:function(a,b){var c={projection:new OpenLayers.Projection("EPSG:900913"),units:"m",maxResolution:"auto",maxExtent:new OpenLayers.Bounds(-2.003750834E7,-2.003750834E7,2.003750834E7,2.003750834E7),controls:[new OpenLayers.Control.Navigation,new OpenLayers.Control.LayerSwitcher,new OpenLayers.Control.PanZoomBar,new OpenLayers.Control.Attribution,new OpenLayers.Control.ScaleLine({geodesic:!0})]},c=new OpenLayers.Map(a,
c),d=new OpenLayers.Layer.OSM("Mapnik");c.addLayer(d);this.loadValidationLayer(c,b);this.zommToBBoxFromWMSLayer(c,b.wms_url,b.layer_id);return c}};VK2.Utils.AppLoader=VK2.Class({_settings:{vk2LayersearchPanel:"vk2LayersearchPanel",vk2LayersearchControl:"vk2LayersearchControl",vk2LayerbarPanel:"vk2LayerbarPanel",vk2LayerbarControl:"vk2LayerbarControl",vk2Gazetteer:"vk2GazetteerSearchInput",vk2GeorefChooser:"vk2GeorefPanel",vk2GeorefChooserControl:"vk2GeorefControl",vk2Sidebar:"vk2SBPanel",map:null,mapController:null,timeParameter:initConfiguration.timeParameter,georeference_grid:initConfiguration.georeference_grid,slimToolPanels:["vk2LayersearchPanel",
"vk2LayerbarPanel"]},_sidebar:null,_checkIfToolContainerIsInit:function(a){return document.getElementById(a)?!0:!1},_initializeMapController:function(a,b){VK2.Controller.MapController.initialize(this._settings.map,{vk2layermanagement:b,vk2layersearch:a,vk2timefeaturecontrols:VK2.Controller.TimeFeatureControls})},_loadToolGazeetter:function(){this._checkIfToolContainerIsInit(this._settings.vk2Gazetteer)&&VK2.Tools.addGazetteer(this._settings.vk2Gazetteer,this._settings.map)},_loadToolGeoreferencerChooser:function(){var a=
new VK2.Tools.GeoreferencerChooser({wmsLayer:this._settings.georeference_grid.wms,requestWfs:this._settings.georeference_grid.wfs,map:this._settings.map});this._sidebar.appendSlimControl(this._settings.vk2GeorefChooserControl,a);a=VK2.Utils.getAllUrlParams();"georef"in a&&"on"==a.georef&&$("#"+this._settings.vk2GeorefChooserControl).click()},_loadToolLayerbar:function(){var a={map:this._settings.map,div:document.getElementById(this._settings.vk2LayerbarPanel),id:"layerbar_1",vk2featurelayer:VK2.Controller.TimeFeatureControls},
a=new VK2.Tools.Layerbar(a);this._sidebar.appendControl(this._settings.vk2LayerbarControl,this._settings.vk2LayerbarPanel,a);return a},_loadToolLayersearch:function(){var a=new VK2.Tools.Layersearch(document.getElementById(this._settings.vk2LayersearchPanel),this._settings.map,this._settings.timeParameter,this._settings.mapController);this._sidebar.appendControl(this._settings.vk2LayersearchControl,this._settings.vk2LayersearchPanel,a);return a},_loadToolSidebar:function(a){this._checkIfToolContainerIsInit(this._settings.vk2Sidebar)&&
(this._sidebar=new VK2.Tools.Sidebar({},this._settings.mapController,a))},_updateSettings:function(a){for(var b in a)this._settings[b]=a[b]},initialize:function(a){this._updateSettings(a)},loadFatApp:function(){this.loadSlimApp();this._loadToolGeoreferencerChooser()},loadSlimApp:function(){this._loadToolGazeetter();this._loadToolSidebar(this._settings.slimToolPanels);var a=this._loadToolLayersearch(),b=this._loadToolLayerbar();this._initializeMapController(a,b)}});VK2.Login={createSubmitLoginBtn:function(){$("#submitPasswortBtn").click(function(){VK2.Login.validateLoginForm()&&$.ajax({type:"POST",url:"/vkviewer/sign/in",data:{username:$("#loginUsername").val(),password:$("#loginPassword").val(),"form.submitted":!0,came_from:"/vkviewer/sign/getscreen"},success:function(a,b,c){b=!1;try{b=JSON.parse(a),console.log(b)}catch(d){}b?$("#validationTips").html(b.message).addClass("ui-state-error"):(a=document.createElement("a"),a.href="../auth",a.target="_top",document.body.appendChild(a),
a.click())}})})},createSubmitNewUserBtn:function(){$("#submitNewUserBtn").click(function(){VK2.Login.validateNewLoginForm()&&$.ajax({type:"POST",url:"/vkviewer/sign/new",data:{username:$("#loginNewUsername").val(),password:$("#loginNewPassword").val(),email:$("#loginNewEmail").val(),vorname:$("#loginNewVorname").val(),nachname:$("#loginNewNachname").val(),"form.submitted":!0,came_from:"/vkviewer/sign/getscreen"},success:function(a,b,c){b=!1;try{b=JSON.parse(a),console.log(b)}catch(d){}b?$("#validationTips").html(b.message).addClass("ui-state-error"):
(a=document.createElement("a"),a.href="../auth",a.target="_top",document.body.appendChild(a),a.click())}})})},initializeForgetPwDialog:function(a){var b=document.getElementById("forgetPwDialog");$(b).dialog({autoOpen:!1,height:300,width:500,modal:!0,buttons:{btnName:function(){var a=$(document.getElementById("forgetDialogUsername")),b=$(document.getElementById("forgetDialogMail"));validateDialogForm(a,b)&&$.ajax({type:"POST",url:getHost("/vkviewer/sign/reset"),data:{username:a.val(),email:b.val(),
"form.submitted":"Reset Passwort",came_from:"/vkviewer/static/login.html"},success:function(a){console.log(a.message);$(document.getElementById("forgetPwDialog")).dialog("close")}})}},close:function(){$(document.getElementById("forgetDialogUsername")).val("").removeClass("ui-state-error");$(document.getElementById("forgetDialogMail")).val("").removeClass("ui-state-error")}});$("#openForgetPwDialog").click(function(){$(b).dialog("open")})},validateDialogForm:function(a,b){var c=$(document.getElementById("forgetDialogValidationTips")),
d;return d=(d=VK2.Login.Utils.checkUsername(a,c))&&VK2.Login.Utils.checkEmail(b,c)},validateLoginForm:function(){var a=$(document.getElementById("validationTips")),b=$(document.getElementById("loginUsername")),c=$(document.getElementById("loginPassword"));return b=(b=VK2.Login.Utils.checkUsername(b,a))&&VK2.Login.Utils.checkPassword(c,a)},validateNewLoginForm:function(){var a=$(document.getElementById("validationTips")),b=$(document.getElementById("loginNewUsername")),c=$(document.getElementById("loginNewEmail")),
d=$(document.getElementById("loginNewVorname")),e=$(document.getElementById("loginNewNachname")),f=$(document.getElementById("loginNewPassword"));return b=(b=(b=(b=(b=VK2.Login.Utils.checkUsername(b,a))&&VK2.Login.Utils.checkEmail(c,a))&&VK2.Login.Utils.checkName(d,a,"Vorname"))&&VK2.Login.Utils.checkName(e,a,"Nachname"))&&VK2.Login.Utils.checkPassword(f,a)}};
VK2.Login.Utils={updateTips:function(a,b){a.text(b).addClass("ui-state-highlight");setTimeout(function(){a.removeClass("ui-state-highlight",1500)},500)},checkLength:function(a,b,c,d,e){if(a.val().length>c||a.val().length<b)return a.addClass("ui-state-error"),VK2.Login.Utils.updateTips(d,e),!1;a.hasClass("ui-state-error")&&a.removeClass("ui-state-error");return!0},checkRegexp:function(a,b,c,d){if(b.test(a.val()))return a.hasClass("ui-state-error")&&a.removeClass("ui-state-error"),!0;a.addClass("ui-state-error");
VK2.Login.Utils.updateTips(c,d);return!1},checkName:function(a,b,c){return c=(c=VK2.Login.Utils.checkLength(a,3,16,b,"Der "+c+" sollte zwischen 3 und 16 Zeichen umfassen"))&&VK2.Login.Utils.checkRegexp(a,/^([a-zA-Z])+$/,b,"Der Name sollte sich aus Buchstaben des Alphabets zusammensetzen")},checkUsername:function(a,b){var c;return c=(c=VK2.Login.Utils.checkLength(a,3,16,b,"Der Benutzername sollte zwischen 3 und 16 Zeichen umfassen"))&&VK2.Login.Utils.checkRegexp(a,/^([0-9a-zA-Z])+$/,b,"Der Benutzername sollte sich aus des Alphabets oder Zahlen zwischen 0 und 9 zusammensetzen")},
checkPassword:function(a,b){var c;return c=(c=VK2.Login.Utils.checkLength(a,5,16,b,"Das Passwort sollte zwischen 5 und 16 Zeichen umfassen"))&&VK2.Login.Utils.checkRegexp(a,/^([0-9a-zA-Z])+$/,b,"Das Passwort sollte sich aus des Alphabets oder Zahlen zwischen 0 und 9 zusammensetzen")},checkEmail:function(a,b){var c;return c=(c=VK2.Login.Utils.checkLength(a,6,80,b,"Die Email sollte zwischen 6 und 80 Zeichen umfassen"))&&VK2.Login.Utils.checkRegexp(a,/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i,
b,"z.B. Max.Mustermann@slub-dresden.de")}};VK2.Styles.FeatureLayerStyles={_defaultStyle:{fillColor:"#ee9900",fillOpacity:"0"},_tmpStyle:{fillColor:"#FF5500",fillOpacity:"0.4",strokeColor:"#FF0000",labelAlign:"cc",fontColor:"#000000",fontOpacity:1,fontFamily:"Arial",fontSize:16,fontWeight:"600"},_defaultStyleMap:new OpenLayers.StyleMap({fillColor:"#ee9900",fillOpacity:"0"}),_georeferenceLayerStyles:new OpenLayers.StyleMap({"default":new OpenLayers.Style({pointRadius:6,strokeColor:"#ff6103",fillColor:"#FF0000",fillOpacity:0.4,strokeWidth:2})})};var Mediator=function(){var a=function(a,b){console.log("Channel "+a+" subscribed!");Mediator.channels[a]||(Mediator.channels[a]=[]);Mediator.channels[a].push({context:this,callback:b});return this},b=function(a){console.log("Channel "+a+" published!");if(!Mediator.channels[a])return!1;for(var b=Array.prototype.slice.call(arguments,1),e=0,f=Mediator.channels[a].length;e<f;e++){var g=Mediator.channels[a][e];g.callback.apply(g.context,b)}return this};return{channels:{},publish:b,subscribe:a,installTo:function(c){c.subscribe=
a;c.publish=b}}}();VK2.Controller.MapController=function(){var a=null,b=[new OpenLayers.Control.Navigation],c={moveend:function(){var a={centerPoint:this.getCenter(),extent:this.getExtent(),zoom:this.getZoom()};VK2.Controller.MapController.publish("mapmove",a)}},d={addtimelayer:function(a){a=new VK2.Layer.Vk2Layer(a);VK2.Controller.MapController.addTimeLayer(a)},mapmove:function(a){"vk2layersearch"in e&&e.vk2layersearch.updateFeatureStore()}},e={};return{initialize:function(f,g){a=f;for(var h in g)e[h]=g[h];for(h=0;h<
b.length;h++)a.addControl(b[h]);for(var k in c)a.events.register(k,a,c[k]);for(var l in d)VK2.Controller.MapController.subscribe(l,d[l])},getMap:function(){return a},setMap:function(b){a=b},addTimeLayer:function(a){"vk2layermanagement"in e?e.vk2layermanagement.addLayer(a):console.log("VK2.Controller.MapController can not identifier the Vk2LayerManagement tool!")},activateTimeFeatureControl:function(){for(var b=0;b<e.length;b++)e[b].deactivate(a);e.vk2timefeaturecontrols.activate(a)}}}();Mediator.installTo(VK2.Controller.MapController);VK2.Controller.TimeFeatureControls=function(){var a=!1,b=[],c=[],d=function(){c=[];var a=new OpenLayers.Control.SelectFeature(b,{clickout:!0,onSelect:$.proxy(function(a){var b=a.data.original;$.fancybox.open([{href:b,title:'<a href="'+b+'">Download Karte</a>       <a href="'+a.data.permalink+'">Gehe zu Kartenforum</a>'}]);c[0].unselect(a)},this)});c.push(a)},e=function(){if(a)for(var d=0;d<c.length;d++)c[d].setLayer(b)};return{addLayerToControls:function(a){b.push(a);e()},removeLayerFromControls:function(a){a=
b.indexOf(a);b.splice(a,1);e()},activate:function(b){d();for(var e=0;e<c.length;e++)b.addControl(c[e]),c[e].activate(),VK2.Utils.fixControlConflictsOnOLMap(c[e]);a=!0},deactivate:function(b){for(var d=0;d<c.length;d++)c[d].deactivate(),b.removeControl(c[d]);a=!1}}}();VK2.Controller.SidebarController=VK2.Class({_settings:{speed:300,panelLocation:"right",sidebarPanel:"vk2SBPanel",sidebarHeaderLabel:"vk2SBHeaderLabel",sidebarContentPanel:"vk2SBContentPanel",sidebarPanelWidth:300,sidebarCloseBtn:"vk2SBClose"},_sidebar:$("#vk2SBPanel"),_mapController:null,_controls:[],_controlElements:[],_activateControl:function(a,b){this._deactivateControls();this._deactivateControlElements();b.activate();this._changeHeader(b.NAME);a.addClass("open");$("#"+a.attr("value")).css("display",
"block")},_changeHeader:function(a){var b=$("#"+this._settings.sidebarHeaderLabel);b.empty();$("<h4/>",{html:a}).appendTo(b)},_closeSlidebar:function(){this._deactivateControls();this._deactivateControlElements();this._slideIn();this._mapController.activateTimeFeatureControl()},_createControlBehavior:function(a,b){$("#"+a).click($.proxy(function(a){a=$(a.currentTarget);a.hasClass("open")?this._closeSlidebar():(this._activateControl(a,b),this._slideOut())},this))},_createSlimControlBehavior:function(a,
b){$("#"+a).click($.proxy(function(a){a=$(a.currentTarget);a.hasClass("open")?this._closeSlidebar():(this._activateControl(a,b),this._slideIn())},this))},_deactivateControls:function(){for(var a=0;a<this._controls.length;a++)this._controls[a].deactivate()},_deactivateControlElements:function(){for(var a=0;a<this._controlElements.length;a++)this._controlElements[a].removeClass("open"),$("#"+this._controlElements[a].attr("value")).css("display","none")},_updateSettings:function(a){for(var b in a)this._settings[b]=
a[b];this._sidebar=$("#"+this._settings.sidebarPanel)},_loadCloseBehavior:function(){null!=document.getElementById(this._settings.sidebarCloseBtn)&&$(document.getElementById(this._settings.sidebarCloseBtn)).click($.proxy(function(){this._closeSlidebar()},this)).hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")})},_registerControl:function(a,b){this._createControlBehavior(a,b);this._controls.push(b);this._controlElements.push($("#"+a))},_registerSlimControl:function(a,
b){this._createSlimControlBehavior(a,b);this._controls.push(b);this._controlElements.push($("#"+a))},_slideIn:function(){if("right"==this._settings.panelLocation){var a=$("#"+this._settings.sidebarContentPanel);this._sidebar.animate({right:"-"+this._settings.sidebarPanelWidth},this._settings.speed,function(){a.css("display","none")}).removeClass("open")}},_slideOut:function(){$("#"+this._settings.sidebarContentPanel).css("display","block");"right"==this._settings.panelLocation&&this._sidebar.animate({right:"-3px"},
this._settings.speed).addClass("open")},initialize:function(a,b){this._mapController=b;this._updateSettings(a);this._loadCloseBehavior()}});VK2.Controller.GeoreferenceController=function(){var a=OpenLayers.Class(OpenLayers.Control,{initialize:function(a,b){OpenLayers.Control.prototype.initialize.apply(this,[b]);this.layer=a;this.handler=new OpenLayers.Handler.Feature(this,a,{click:this.clickFeature})},clickFeature:function(a){void 0==a.fid?this.layer.destroyFeatures([a]):(this.layer.drawFeature(a,{display:"none"}),this.layer.removeFeatures(a),this.layer.events.triggerEvent("afterfeaturemodified",{feature:a}))},setMap:function(a){this.handler.setMap(a);
OpenLayers.Control.prototype.setMap.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.DeleteFeature"}),b={map:null,vectorLayer:null,toggleElements:{moveMap:"noneToggle",drawPoint:"pointToggle",movePoint:"dragToggle",deletePoint:"deleteToggle"},formElements:{hiddenPoints:"points",hiddenMtbId:"mtbid",btnValidate:"btnValidate",btnSubmit:"btnSubmit"},loadingScreen:"georefLoadingScreen",urls:{validate:"../georef/validate",submit:"../georef/confirm",validatePage:"../georeference/validate",submitPage:"../auth"},
anchorIndexPage:"anchorBackToIndexPage",urlParams:{},status:"georeference"},c={},d=function(){c={point:new OpenLayers.Control.DrawFeature(b.vectorLayer,OpenLayers.Handler.Point,{eventListeners:{featureadded:function(){4<this.layer.features.length&&alert("Nur 4 Eckpunkte zul\u00e4ssig");this.layer.removeFeatures(this.layer.features[4])}}}),drag:new OpenLayers.Control.DragFeature(b.vectorLayer),modify:new OpenLayers.Control.ModifyFeature(b.vectorLayer),"delete":new a(b.vectorLayer)};for(var d in c)b.map.addControl(c[d])},
e=function(){var a=c,d;for(d in b.toggleElements)$("#"+b.toggleElements[d]).click(function(b){for(var c in a){var d=a[c];b.currentTarget.value==c&&b.currentTarget.checked?d.activate():d.deactivate()}})},f=function(){var a=b.vectorLayer;"georeference"==b.status?$("#"+b.formElements.btnSubmit).click(function(c){if(h(a)){c=b.urlParams.mtbid;var d=document.getElementById(b.formElements.hiddenPoints).value;console.log(c);console.log(d);$("#"+b.loadingScreen).css({display:"block","z-index":"2000"});$.ajax({url:b.urls.submit,
type:"GET",data:{mtbid:c,points:d},success:function(a){$("#"+b.loadingScreen).css({display:"none","z-index":"0"});console.log(a);document.getElementById(b.anchorIndexPage).click()},error:function(a){$("#"+b.loadingScreen).css({display:"none","z-index":"0"});alert("Die Georeferenzierungsparameter konnten nicht registriert werden")},complete:function(a){$("#"+b.loadingScreen).css({display:"none","z-index":"0"})}})}else console.log("inputs are not valide")}):"validate"==b.status&&$("#"+b.formElements.btnSubmit).click(function(c){if(h(a)){c=
b.urlParams.mtbid;var d=b.urlParams.georefid;$("#"+b.loadingScreen).css({display:"block","z-index":"2000"});$.ajax({url:b.urls.submit,type:"GET",data:{mtbid:c,georefid:d},success:function(a){$("#"+b.loadingScreen).css({display:"none","z-index":"0"});console.log(a);document.getElementById(b.anchorIndexPage).click()},error:function(a){$("#"+b.loadingScreen).css({display:"none","z-index":"0"});alert("Die Georeferenzierungsparameter konnten nicht best\u00e4tigt werden")},complete:function(a){$("#"+b.loadingScreen).css({display:"none",
"z-index":"0"})}})}else console.log("inputs are not valide")})},g=function(){var a=b.vectorLayer;$("#"+b.formElements.btnValidate).click(function(c){if(h(a)){c=b.urlParams.mtbid;var d=document.getElementById(b.formElements.hiddenPoints).value;console.log(c);console.log(d);$("#"+b.loadingScreen).css({display:"block","z-index":"2000"});$.ajax({url:b.urls.validate,type:"GET",data:{mtbid:c,points:d},success:function(a){$("#"+b.loadingScreen).css({display:"none","z-index":"0"});console.log(a);var c=b.urls.validatePage+
"?points="+d+"&",e;for(e in b.urlParams)c=c+e+"="+b.urlParams[e]+"&";a=JSON.parse(a);for(e in a)c=c+e+"="+a[e]+"&";e=document.createElement("a");document.body.appendChild(e);e.href=c;e.click()},error:function(a){$("#"+b.loadingScreen).css({display:"none","z-index":"0"});alert("Es konnte keine Validierung berechnet werden")},complete:function(a){$("#"+b.loadingScreen).css({display:"none","z-index":"0"});console.log(a)}})}else console.log("inputs are not valide")});f()},h=function(a){if(4>a.features.length)return alert("4 Eckpunkte ben\u00f6tigt"),
!1;var c=document.getElementById(b.formElements.hiddenPoints);c.value="";for(var d in a.features)c.value=c.value+a.features[d].geometry.x+":"+a.features[d].geometry.y,c.value=d<a.features.length-1?c.value+",":c.value+"";return!0};return{initialize:function(a){for(var c in a)b[c]=a[c];d();e();g()},getMap:function(a){return b.map}}}();VK2.Layer.GeoreferencerSearchLayer=VK2.Class({_settings:{wmsLayer:null,selectLayer:null,requestWfs:null,map:null,controls:{getfeature:null},eventListeners:{featureselected:function(a){this._settings.selectLayer.addFeatures([a.feature]);console.log("Feature selected - MTB "+a.feature.attributes.blattnr+", ID "+a.feature.attributes.id);a=VK2.Utils.getHost("vkviewer/choosegeoref?blattnr=")+a.feature.attributes.blattnr;$.fancybox.open([{href:a,width:"100%",height:"100%",type:"iframe"}])},featureunselected:function(a){this._settings.selectLayer.removeFeatures([a.feature]);
console.log("Feature unselected!")}}},_addLayersToMap:function(){this._settings.map.addLayers([this._settings.wmsLayer,this._settings.selectLayer])},_addGetFeaturesControlToMap:function(){this._settings.map.addControl(this._settings.controls.getfeature);this._settings.controls.getfeature.activate()},_removeLayersToMap:function(){this._settings.map.removeLayer(this._settings.wmsLayer);this._settings.map.removeLayer(this._settings.selectLayer)},_removeGetFeaturesControlToMap:function(){this._settings.map.removeControl(this._settings.controls.getfeature);
this._settings.controls.getfeature.deactivate()},_loadOLElements:function(){this._settings.selectLayer=new OpenLayers.Layer.Vector("georeferencer_select_1",{styleMap:new OpenLayers.Style(OpenLayers.Feature.Vector.style.select)});this._settings.controls.getfeature=new OpenLayers.Control.GetFeature({name:"georeferencer_control_1",protocol:this._settings.requestWfs});for(var a in this._settings.eventListeners)this._settings.controls.getfeature.events.register(a,this,this._settings.eventListeners[a])},
_updateSettings:function(a){for(var b in a)this._settings[b]=a[b]},initialize:function(a){this._updateSettings(a);this._loadOLElements()},activate:function(){this._addLayersToMap();this._addGetFeaturesControlToMap()},deactivate:function(){if(null!=this._settings.wmsLayer.map||"undefined"==this._settings.wmsLayer.map)this._removeLayersToMap(),this._removeGetFeaturesControlToMap()}});VK2.Layer.TimeFeatureLayer=VK2.Class({_timeFtLayer:null,_wfsProtocol:null,_timeLayer:null,_actualTimestamp:null,_refresh:null,_eventsOnParentLayer:{visibilitychanged:function(a){this.getVisibility()&&"undefined"!==this.timeFtLayer?(this.timeFtLayer.setVisibility(!0),this.timeFtLayer.refresh()):this.getVisibility()||"undefined"===this.timeFtLayer?console.log("No TimeFeatureLayer is registered!"):this.timeFtLayer.setVisibility(!1)},added:function(a){this.getVisibility()&&"undefined"!==this.timeFtLayer&&
(this.timeFtLayer._initializeTimeLayer(this.map),VK2.Controller.TimeFeatureControls.addLayerToControls(this.timeFtLayer.getLayer()))},removed:function(a){"undefined"!==this.timeFtLayer&&(this.map.removeLayer(this.timeFtLayer.getLayer()),VK2.Controller.TimeFeatureControls.removeLayerFromControls(this.timeFtLayer.getLayer()))}},_lastSelectedFeatures:[],_initializeTimeLayer:function(a){this._actualTimestamp=this._timeLayer.params.TIME;this._refresh=new OpenLayers.Strategy.Refresh({force:!0,active:!0});
this._timeFtLayer=new OpenLayers.Layer.Vector(OpenLayers.Util.createUniqueID("TimeFeatureLayer_"),{displayInLayerSwitcher:!1,styleMap:VK2.Styles.FeatureLayerStyles._defaultStyleMap,strategies:[new OpenLayers.Strategy.BBOX,this._refresh],protocol:this._wfsProtocol,filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"time",value:this._actualTimestamp})},{visibility:!0});a.addLayer(this._timeFtLayer)},_initializeParentLayerEvents:function(){for(var a in this._eventsOnParentLayer)this._timeLayer.events.register(a,
this._timeLayer,this._eventsOnParentLayer[a])},_updateFilter:function(){this._timeFtLayer.filter=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"time",value:this._actualTimestamp});this.refresh()},initialize:function(a,b){this._wfsProtocol=b;this._timeLayer=a;this._initializeParentLayerEvents()},getLayer:function(){return this._timeFtLayer},updateFeatures:function(){this._timeLayer.params.TIME!=this._timeFtLayer._actualTimestamp&&(this._actualTimestamp=this._timeLayer.params.TIME,
this._updateFilter())},setVisibility:function(a){this._timeFtLayer&&this._timeFtLayer.setVisibility(a)},refresh:function(){this._timeFtLayer&&(this._refresh.refresh(),this._timeFtLayer.redraw())}});VK2.Layer.Vk2Layer=function(a){var b=new OpenLayers.Layer.WMS(a.layer,a.wms,{layers:a.wms_layer,type:"png",format:"image/png",transparent:"true",time:a.time},{isBaseLayer:!1,visibility:!0,projection:new OpenLayers.Projection(a.srsName)});b.timeFtLayer=new VK2.Layer.TimeFeatureLayer(b,new OpenLayers.Protocol.WFS({url:a.wfs,geometryName:a.geometryName,featureNS:a.featureNS,featurePrefix:a.featurePrefix,featureType:a.featureType,srsName:a.srsName,maxFeatures:a.maxFeatures,version:a.serviceVersion}));
b.wfsLayer=new OpenLayers.Layer.Vector(a.featureType,{displayInLayerSwitcher:!1,styleMap:new OpenLayers.StyleMap({fillColor:"#ee9900",fillOpacity:"0.5"}),strategies:[new OpenLayers.Strategy.BBOX,new OpenLayers.Strategy.Refresh({force:!0,active:!0})],protocol:new OpenLayers.Protocol.WFS({url:a.wms,geometryName:a.geometryName,featureNS:a.featureNS,featurePrefix:a.featurePrefix,featureType:a.featureType,srsName:a.srsName,maxFeatures:a.maxFeatures,version:a.serviceVersion})});b.id=OpenLayers.Util.createUniqueID(a.layer.split(" ").join("_")+
"_");b.isTime=!0;b.thumbnail="/vkviewer/static/images/layer_default.png";b.extent=a.extent;return b};VK2.Tools.addGazetteer=function(a,b){$(document.getElementById(a)).autocomplete({source:function(a,d){VK2.Validation.isBlattnumber(a.term)?(d(),$.ajax({url:"/vkviewer/proxy/?url=http://139.30.111.16/fgs/vkll/fragblattnr.php?blattnr="+a.term,success:$.proxy(function(a){""!=a?(a=JSON.parse(a),VK2.Utils.jumptolonlat(b,a.coordinates[0],a.coordinates[1])):alert(VK2.Utils.get_I18n_String("noResultsBlattnr"))},this)})):$.ajax({url:"http://open.mapquestapi.com/nominatim/v1/search.php",dataType:"json",data:{featureClass:"P",
style:"full",maxRows:8,format:"json",q:a.term,viewbox:"4.35,58.48,27.78,45.97",bounded:1},success:function(a){d($.map(a,function(a){return{label:a.display_name,value:a.display_name,lonlat:new OpenLayers.LonLat(a.lon,a.lat),type:a.type}}))}})},delay:500,minLength:3,select:function(a,d){b.setCenter(d.item.lonlat.transform(new OpenLayers.Projection("EPSG:4326"),b.getProjectionObject(),12))},open:function(){$(this).removeClass("ui-corner-all").addClass("ui-corner-top")},close:function(){$(this).removeClass("ui-corner-top").addClass("ui-corner-all")}})};VK2.Tools.GeoreferencerChooser=VK2.Class({_settings:{wmsLayer:new OpenLayers.Layer.WMS("georeferencer_wms_1","http://194.95.145.43/cgi-bin/mtb_grid",{layers:"mtb_grid_puzzle",transparent:!0},{isBaseLayer:!1,displayInLayerSwitcher:!0,singleTile:!0}),requestWfs:new OpenLayers.Protocol.WFS({url:"http://194.95.145.43/cgi-bin/mtb_grid",geometryName:"the_geom",featureNS:"http://mapserver.gis.umn.edu/mapserver",featurePrefix:"ms",featureType:"mtb_grid",srsName:"EPSG:3857",maxFeatures:1E3,version:"1.0.0"}),
map:null},_georefLayer:null,_loadGeoreferenceSearchLayer:function(){this._georefLayer=new VK2.Layer.GeoreferencerSearchLayer({wmsLayer:this._settings.wmsLayer,requestWfs:this._settings.requestWfs,map:this._settings.map})},_updateSettings:function(a){for(var b in a)this._settings[b]=a[b]},initialize:function(a){this._updateSettings(a);this._loadGeoreferenceSearchLayer()},activate:function(){this._georefLayer.activate()},deactivate:function(){this._georefLayer.deactivate()}});VK2.Tools.Georeferencer=VK2.Class({_settings:{urlParams:null,container:"vk2GeoreferenceToolsPanel",handler:"vk2GeoreferenceToolsHandle",map:null,controller:VK2.Controller.GeoreferenceController,vectorLayer:null,status:"georeference"},_loadHTMLContent:function(){var a=$("<div/>",{"class":"GeoreferenceToolsContent"}).appendTo("#vk2GeoreferenceToolsPanel"),a=$("<ul/>",{id:"controlsList","class":"controlsList"}).appendTo(a),b=$("<li/>").appendTo(a);$("<input/>",{type:"radio",name:"type",value:"none",
id:"noneToggle",checked:"checked"}).appendTo(b);$("<label/>",{"for":"noneToggle",html:VK2.Utils.get_I18n_String("moveMap")}).appendTo(b);b=$("<li/>").appendTo(a);$("<input/>",{type:"radio",name:"type",value:"point",id:"pointToggle"}).appendTo(b);$("<label/>",{"for":"pointToggle",html:VK2.Utils.get_I18n_String("setCornerPoint")}).appendTo(b);b=$("<li/>").appendTo(a);$("<input/>",{type:"radio",name:"type",value:"drag",id:"dragToggle"}).appendTo(b);$("<label/>",{"for":"dragToggle",html:VK2.Utils.get_I18n_String("moveCornerPoint")}).appendTo(b);
b=$("<li/>").appendTo(a);$("<input/>",{type:"radio",name:"type",value:"delete",id:"deleteToggle"}).appendTo(b);$("<label/>",{"for":"deleteToggle",html:VK2.Utils.get_I18n_String("deleteCornerPoint")}).appendTo(b);$("<br/>").appendTo(a);$("<input/>",{type:"hidden",id:"mtbid",name:"mtbid"}).appendTo(a);$("<input/>",{type:"hidden",id:"points",name:"points"}).appendTo(a);this._loadHTMLEventBtns(a)},_loadHTMLEventBtns:function(a){var b,c="";"georeference"==this._settings.status?(b=VK2.Utils.get_I18n_String("validateBtn_georeference"),
c=VK2.Utils.get_I18n_String("submitBtn_georeference")):"validate"==this._settings.status&&(b=VK2.Utils.get_I18n_String("validateBtn_validate"),c=VK2.Utils.get_I18n_String("submitBtn_validate"));$("<input/>",{type:"button",id:"btnValidate","class":"vk2GeorefToolsBtn",value:b}).appendTo(a);$("<input/>",{type:"button",id:"btnSubmit","class":"vk2GeorefToolsBtn",value:c}).appendTo(a)},_loadLayerPointsFromUrl:function(){if("points"in this._settings.urlParams)for(zaehler in returnpoints=this._settings.urlParams.points.split(","),
returnpoints)latLon=returnpoints[zaehler],latLon=latLon.replace(/:/g,","),latLon=latLon.split(","),kringel=new OpenLayers.Geometry.Point(latLon[0],latLon[1]),this._settings.vectorLayer.addFeatures([new OpenLayers.Feature.Vector(kringel)])},_loadGeoreferenceToolLayers:function(){var a=OpenLayers.Util.getParameters(window.location.href).renderer,a=a?[a]:OpenLayers.Layer.Vector.prototype.renderers;this._settings.vectorLayer=new OpenLayers.Layer.Vector("Eckpunkte",{styleMap:VK2.Styles.FeatureLayerStyles._georeferenceLayerStyles,
renderers:a});this._settings.map.addLayer(this._settings.vectorLayer);this._loadLayerPointsFromUrl()},_loadGeoreferenceTabSlider:function(){$("#"+this._settings.container).tabSlideOut({tabHandle:"."+this._settings.handler,pathToTabImage:$("#"+this._settings.handler).attr("data-open"),pathToTabImageClose:$("#"+this._settings.handler).attr("data-close"),imageHeight:"40px",imageWidth:"40px",speed:300,action:"click",topPos:"250px",fixedPosition:!1,onLoadSlideOut:!0})},_loadGeoreferenceTools:function(){this._loadGeoreferenceToolLayers();
this._loadGeoreferenceTabSlider()},_updateSettings:function(a){for(var b in a)this._settings[b]=a[b]},_initializeGeoreferenceController:function(){this._settings.controller.initialize({map:this._settings.map,vectorLayer:this._settings.vectorLayer,urlParams:this._settings.urlParams,status:this._settings.status})},initialize:function(a){this._updateSettings(a);this._loadHTMLContent();this._loadGeoreferenceTools();document.getElementById("mtbid").value=VK2.Utils.get_url_param("mtbid");this._initializeGeoreferenceController()}});VK2.Tools.Layersearch=VK2.Class({NAME:VK2.Utils.get_I18n_String("toolname_layersearch"),_PubSubHandler:null,_timeParameter:null,_isInit:!1,_isOpen:!1,_map:null,_features:null,_timeLayer:null,_timestamps:[1868,1945],_refresh:new OpenLayers.Strategy.Refresh({force:!0,active:!0}),_featureStore:null,_mainPanel:null,_restrictedZoomLevel:2,_isActive:!1,_eventListeners:{showSearchResultNumber:function(a){console.log("Type: "+a.type);console.log("Features: "+this.features.length);var b=$("#vk2LSHeaderContent"),
c=$("#vk2LSHeaderContainer");2<=this.map.getZoom()&&this.getVisibility()?(b.html(this.features.length+" "+VK2.Utils.get_I18n_String("found_mtb")),c.hasClass("ui-state-error")&&c.removeClass("ui-state-error"),"visibilitychanged"==a.type&&this.refresh({force:!0})):(b.html(VK2.Utils.get_I18n_String("change_zoomlevel")),c.addClass("ui-state-error"))},loadStarts:function(a){console.log("Loadstarts");$("#vk2LSHeaderLoadingContainer").addClass("loading")},loadEnds:function(a){console.log("Loadends");$("#vk2LSHeaderLoadingContainer").hasClass("loading")&&
$("#vk2LSHeaderLoadingContainer").removeClass("loading")},publishAddTimeLayerEvent:function(a,b,c,d){null!=b?4==a.length&&"number"===typeof parseInt(a)?(c.extent=d.getExtent(),c.time=a,b.publish("addtimelayer",c)):alert(VK2.Utils.get_I18n_String("choose_valide_timestamp")):console.log("Missing publish/subscription handler")}},_loadToolbar:function(){var a=document.createElement("div");a.className+=" vk2LSToolPanel vk2LSToolbar";a.id="vk2LSToolbar";var b=document.createElement("div");b.className+=
" vk2TimeSliderLabel1";var c=document.createElement("div");c.className+=" vk2TimeSliderLabel2";var d=document.createElement("div");d.className+=" vk2TimeSliderDiv";var e=document.createElement("div");e.className+=" vk2AddLayerDiv";var f=document.createElement("input");f.className+=" vk2AddLayerInput";f.id="vk2AddLayerInput";f.type="text";var g=document.createElement("div");g.id="vk2AddLayerButton";g.innerHTML=VK2.Utils.get_I18n_String("displaytimestamp");e.appendChild(f);e.appendChild(g);a.appendChild(b);
a.appendChild(c);a.appendChild(d);a.appendChild(e);d=$(d).slider({range:!0,min:this._timestamps[0],max:this._timestamps[1],values:this._timestamps,animate:"slow",orientation:"horizontal",step:1,slide:function(a,d){$(b).text(d.values[0]);$(c).text(d.values[1])},change:$.proxy(function(a,b){this._updateFeatures(a,b.values)},this)});$(b).text(d.slider("values",0));$(c).text(d.slider("values",1));$(g).button().click($.proxy(function(a){a=$("#vk2AddLayerInput").val();this._eventListeners.publishAddTimeLayerEvent(a,
this._PubSubHandler,this._timeParameter,this._map)},this));return a},_loadHeader:function(){var a=document.createElement("div");a.className+=" vk2LSHeaderContainer ui-state-error";a.id="vk2LSHeaderContainer";var b=document.createElement("div");b.className+=" vk2LSHeaderContent";b.id="vk2LSHeaderContent";b.innerHTML="Bitte w\u00e4hlen Sie eine h\u00f6here Zoomstufe!";a.appendChild(b);b=document.createElement("div");b.className+=" vk2LSHeaderLoadingContainer";b.id="vk2LSHeaderLoadingContainer";a.appendChild(b);
return a},_loadContent:function(a,b){this._addTimeSearchLayer();this._featureStore=new GeoExt.data.FeatureStore({layer:this._timeLayer,features:this._features,fields:[{name:"mtbid",type:"string"},{name:"time",type:"string"},{name:"titel",type:"string"}]});var c=this._loadHeader();a.appendChild(c);var d=this._loadToolbar();a.appendChild(d);this._mainPanel=new Ext.Panel({renderTo:a.getAttribute("id"),id:"vk2LSMainPanel",cls:"vk2LSMainPanel",items:[{id:"vk2HeaderPanel",cls:"vk2HeaderPanel",height:45,
contentEl:c.getAttribute("id")},{xtype:"grid",width:385,height:300,store:this._featureStore,cm:new Ext.grid.ColumnModel([{id:"time",header:VK2.Utils.get_I18n_String("timestamp"),dataIndex:"time",sortable:!0},{id:"titel",header:VK2.Utils.get_I18n_String("titel"),dataIndex:"titel",sortable:!0}]),sm:new GeoExt.grid.FeatureSelectionModel({singleSelect:!1}),listeners:{rowclick:$.proxy(function(a,b,c){a=a.store.data.items[b];document.getElementById("vk2AddLayerInput").setAttribute("value",a.data.time)},
this),rowdblclick:$.proxy(function(a,b,c){this._map.setCenter(a.store.data.items[b].data.feature.bounds.getCenterLonLat(),9)},this),sortchange:function(a,b){console.log("Sort change event!")}},autoExpandColumn:"titel",id:"featureGridPanel",cls:"featureGridPanel"},{id:"vk2LSToolPanel",cls:"vk2LSToolPanel",contentEl:"vk2LSToolbar",width:385,height:130}],listeners:{afterlayout:$.proxy(function(){this._updateMapControlConfig()},this)}})},_addTimeSearchLayer:function(){this._features=new OpenLayers.Protocol.WFS({url:this._timeParameter.wfs,
geometryName:this._timeParameter.geometryName,featureNS:this._timeParameter.featureNS,featurePrefix:this._timeParameter.featurePrefix,featureType:this._timeParameter.featureType,srsName:this._timeParameter.srsName,maxFeatures:this._timeParameter.maxFeatures,version:this._timeParameter.serviceVersion});this._timeLayer=new OpenLayers.Layer.Vector("Messtischblaetter",{displayInLayerSwitcher:!1,maxResolution:this._timeParameter.maxResolution,visibility:!1,strategies:[new OpenLayers.Strategy.BBOX({ratio:2}),
this._refresh],protocol:this._features});this._map.filter=VK2.Filter.getBoundingBoxFilter(this._map.getExtent(),"EPSG:900913");this._map.addLayer(this._timeLayer);this._addHeaderContentEvent()},_removeTimeSearchLayer:function(){this._map.removeLayer(this._timeLayer)},_updateMapControlConfig:function(){var a=null;controlId=this._map.getControlsByClass("OpenLayers.Control.SelectFeature")[0].id;for(var b=0;b<this._map.controls.length;b++)this._map.controls[b].id==controlId&&(a=this._map.controls[b]);
VK2.Utils.fixControlConflictsOnOLMap(a)},_btnClickEvent:function(a){null!=this._PubSubHandler?(timeValue=$("#vk2AddLayerInput").val(),4==timeValue.length&&"number"===typeof parseInt(timeValue)?(this._timeParameter.extent=this._map.getExtent(),this._timeParameter.time=timeValue,this._PubSubHandler.publish("addtimelayer",this._timeParameter)):alert("W\u00e4hle validien Zeitstempel")):console.log("Missing publish/subscription handler")},_addHeaderContentEvent:function(){this._timeLayer.events.register("visibilitychanged",
this._timeLayer,this._eventListeners.showSearchResultNumber);this._timeLayer.events.register("featuresadded",this._timeLayer,this._eventListeners.showSearchResultNumber);this._timeLayer.events.register("featuresremoved",this._timeLayer,this._eventListeners.showSearchResultNumber);this._timeLayer.events.register("moveend",this._timeLayer,this._eventListeners.showSearchResultNumber);this._timeLayer.events.register("loadstart",this._timeLayer,this._eventListeners.loadStarts);this._timeLayer.events.register("loadend",
this._timeLayer,this._eventListeners.loadEnds)},_isMtbSearchActive:function(){return this._map.getZoom()>=this._restrictedZoomLevel?!0:!1},_updateFeatures:function(a,b){"undefined"!=typeof b&&"slidechange"==a.type?(this._timestamps=b,this._timeLayer.filter=VK2.Filter.getTimeFilter(this._map.getExtent(),"EPSG:900913",b[0],b[1]),this._refresh.refresh()):(this._timeLayer.filter=VK2.Filter.getTimeFilter(this._map.getExtent(),"EPSG:900913",this._timestamps[0],this._timestamps[1]),this._refresh.refresh({forc:!0}))},
_refreshFeatureGrid:function(){this._mainPanel.getComponent("featureGridPanel").getView().refresh()},_activate:function(){this._isMtbSearchActive()?(this._timeLayer.setVisibility(!0),this._featureStore.bind(this._timeLayer)):this._deactivate()},_deactivate:function(){this._timeLayer.setVisibility(!1);this._featureStore.unbind(this._timeLayer);this._featureStore.removeAll()},initialize:function(a,b,c,d){this._PubSubHandler=d;this._timeParameter=c;this._map=b;this._loadContent(a);return this._isInit=
!0},updateFeatureStore:function(a){console.log("Update FeatureStore and is activate "+this._isActive);this._isActive&&(this._updateFeatures(a),this._activate())},activate:function(){this._updateFeatures();this._activate();this._isActive=!0},deactivate:function(){this._deactivate();this._isActive=!1},isInit:function(){return this._isInit},isOpen:function(){return this._isOpen},getMapObject:function(){return this.map}});VK2.Tools.Layerbar=VK2.Class({NAME:VK2.Utils.get_I18n_String("toolname_layerbar"),layersDiv:null,minimizeDiv:null,maximizeDiv:null,overlayLayersDiv:null,displayBtn:null,layerStates:null,map:null,id:null,div:null,ascending:!0,baseLayers:[],overlayLayers:[],_mapController:null,_vk2FeatureLayer:null,initialize:function(a){this.map=a.map;this.div=a.div;this.id=a.id;this._vk2FeatureLayer=a.vk2featurelayer?a.vk2featurelayer:new Vk2FeatureLayer;this.displayBtn=a.displayBtn?a.displayBtn:!1;this.layerStates=
[];this.draw()},destroy:function(){this.clearLayersArray("vk2Data");this.map.events.un({buttonclick:onButtonClick,addlayer:this.redraw,changelayer:this.redraw,removelayer:this.redraw,changebaselayer:this.redraw,scope:this})},setMap:function(a){this.map.events.on({addlayer:this.redraw,changelayer:this.redraw,removelayer:this.redraw,changebaselayer:this.redraw,scope:this})},draw:function(){this._loadContents();this.redraw();return this.div},clearLayersArray:function(a){this[a+"LayersDiv"].innerHTML=
"";this[a+"Layers"]=[]},checkRedraw:function(){if(!this.layerStates.length||this.map.layers.length!=this.layerStates.length)return!0;for(var a=0,b=this.layerStates.length;a<b;a++){var c=this.layerStates[a],d=this.map.layers[a];if(c.name!=d.name||c.inRange!=d.inRange||c.id!=d.id||c.visibility!=d.visibility)return!0}return!1},redraw:function(){if(!this.checkRedraw())return this.div;this.clearLayersArray("overlay");var a=this.map.layers.length;this.layerStates=Array(a);for(var b=0;b<a;b++){var c=this.map.layers[b];
this.layerStates[b]={name:c.name,visibility:c.visibility,inRange:c.inRange,id:c.id}}var d=this.map.layers.slice();this.ascending||d.reverse();b=0;for(a=d.length;b<a;b++){var c=d[b],e=c.isBaseLayer;c.displayInLayerSwitcher&&!e&&(this.overlayLayersDiv.appendChild(this._createLayerElement(c)),this.overlayLayers.push(c))}return this.div},onButtonClick:function(a){a=a.currentTarget;a===this.minimizeDiv?this.minimizeControl():a===this.maximizeDiv?this.maximizeControl():a._layerSwitcher===this.id&&(a["for"]&&
(a=document.getElementById(a["for"])),a.disabled||("radio"==a.type?(a.checked=!0,this.map.setBaseLayer(this.map.getLayer(a._layer))):this.updateMap()))},updateMap:function(){for(var a=0,b=this.baseLayers.length;a<b;a++){var c=this.baseLayers[a];c.inputElem.checked&&this.map.setBaseLayer(c.layer,!1)}a=0;for(b=this.overlayLayers.length;a<b;a++){var c=this.overlayLayers[a],d=document.getElementById(c.id).checked;c.setVisibility(d)}},maximizeControl:function(a){this.div.style.width="";this.div.style.height=
"";this.showControls(!1)},minimizeControl:function(a){this.div.style.width="0px";this.div.style.height="0px";this.showControls(!0)},showControls:function(a){this.maximizeDiv.style.display=a?"":"none";this.minimizeDiv.style.display=a?"none":"";this.layersDiv.style.display=a?"none":""},_opacitySliderEvent:function(a,b){var c=b.value/100;this._getLayerToEvent(a).setOpacity(c);return null},_timeSliderEvent:function(a,b){for(var c=b.value,d=this._getLayerToEvent(a),e=$(document).find("div.vk2Label"),f=
0;f<e.length;f++)e[f].value==a.target.value&&(e[f].innerHTML=d.params.LAYERS+" "+c,d.oldTime=d.params.TIME,d.params.TIME=c,d.timeFtLayer.updateFeatures(),d.redraw(!0))},_createLayerElement:function(a){var b=this._createLayerDomElement(a);this._createEventBehaviorToLayerElem(b,a);return b},_createEventBehaviorToLayerElem:function(a,b){$(a).find("ul").hide();$(a).find(".minimize").find(".vk2Label").click(function(b){$(a).find("ul").slideToggle()});$(a).find(".olButton").click($.proxy(this.onButtonClick,
this));arguments={tooltipDiv:$(a).find(".opacity").find(".toolTip"),sliderDiv:$(a).find(".opacity").find(".sliderContainer"),value:100,min:0,max:100,step:1};this._addSliderBehaviour(arguments,this._opacitySliderEvent);if(b.isTime){arguments={tooltipDiv:$(a).find(".time").find(".toolTip"),sliderDiv:$(a).find(".time").find(".sliderContainer"),value:b.params.TIME,min:1868,max:1945,step:1};this._addSliderBehaviour(arguments,this._timeSliderEvent);var c=b.name+" "+b.params.TIME;$(a).find(".minimize").find(".vk2Label").html(c)}return b},
_createLayerDomElement:function(a){var b=document.createElement("li");b.className+=" overlayElem";var c=document.createElement("div");c.className+=" overlayElemDiv";c.appendChild(this._createMinimizeView_forOverlay(a,this.id));c.appendChild(this._createMaximizeView_forOverlay(a));b.appendChild(c);return b},_addSliderBehaviour:function(a,b){var c=$(a.tooltipDiv);c.hide();var d=$(a.sliderDiv).slider({min:a.min,max:a.max,value:a.value,animate:"slow",orientation:"horizontal",step:1,start:function(a,b){c.fadeIn("fast")},
slide:function(b,f){var g=d.slider("value");c.css("left",-1*(a.min-g)).text(f.value)},stop:function(a,b){c.fadeOut("fast")},change:$.proxy(b,this)});return!0},_getLayerToEvent:function(a){for(var b=0;b<this.map.layers.length;b++)if(this.map.layers[b].id===a.target.value)return this.map.layers[b];return null},_loadContents:function(){this.layersDiv=document.createElement("div");this.layersDiv.id=this.id+"_layersDiv";this.layersDiv.className+=" layersDiv";this.vk2DataLayersLbl=document.createElement("div");
this.vk2DataLayersLbl.innerHTML="Overlays";this.vk2DataLayersLbl.className+=" overlayLbls";this.overlayLayersDiv=document.createElement("div");this.overlayLayersDiv.className+=" overlayDivs";this.layersDiv.appendChild(this.vk2DataLayersLbl);this.layersDiv.appendChild(this.overlayLayersDiv);this.div.appendChild(this.layersDiv);if(!1!=this.displayBtn){var a=OpenLayers.Util.getImageLocation("layer-switcher-maximize.png");this.maximizeDiv=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_MaximizeDiv",
null,null,a,"absolute");OpenLayers.Element.addClass(this.maximizeDiv,"maximizeDiv");this.maximizeDiv.style.display="none";$(this.maximizeDiv).click($.proxy(this.onButtonClick,this));this.div.appendChild(this.maximizeDiv);a=OpenLayers.Util.getImageLocation("layer-switcher-minimize.png");this.minimizeDiv=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_MinimizeDiv",null,null,a,"absolute");OpenLayers.Element.addClass(this.minimizeDiv,"minimizeDiv");this.minimizeDiv.style.display="";$(this.minimizeDiv).click($.proxy(this.onButtonClick,
this));this.div.appendChild(this.minimizeDiv)}},_createMinimizeView_forOverlay:function(a,b){var c=document.createElement("div");c.value=a.id;c.className+=" minimize";var d=document.createElement("input");d.id=a.id;d.name=a.name;d.value=a.name;d.checked=a.getVisibility();d.defaultChecked=a.getVisibility();d.className="olButton";d._layer=a.id;d._layerSwitcher=b;d.type="checkbox";a.inRange||(d.disabled=!0);var e=document.createElement("div");e.value=a.id;e.text=a.name;e.className+=" vk2Label";e.innerHTML=
a.name;c.appendChild(d);c.appendChild(e);return c},_createMaximizeView_forOverlay:function(a){function b(b,c,d){b=document.createElement("div");b.className=b.className+" "+d;d=document.createElement("span");d.className+=" toolTip";b.appendChild(d);d=document.createElement("div");d.innerHTML=c+":";d.className+=" vk2Label";b.appendChild(d);c=document.createElement("div");c.className+=" sliderContainer";c.value=a.id;b.appendChild(c);return b}var c=document.createElement("ul");c.className+=" maximize";
var d=document.createElement("div");d.className+=" container";var e=document.createElement("div");e.className+=" thumbnail";var f=document.createElement("img");f.alt="Noimage";f.src=a.thumbnail;e.appendChild(f);f=document.createElement("div");f.className+=" slider";f.appendChild(b(a.id,"Opacity","opacity"));a.isTime&&f.appendChild(b(a.id,"Time","time"));d.appendChild(e);d.appendChild(f);c.appendChild(d);return c},addLayer:function(a){this.map.addLayer(a);a.isBaseLayer||a.getVisibility();this.redraw();
return!0},activate:function(){this._vk2FeatureLayer.activate(this.map)},deactivate:function(){this._vk2FeatureLayer.deactivate(this.map)},CLASS_NAME:"Vk2.LayerManagement"});VK2.Tools.Sidebar=VK2.Class({_settings:{sidebarPanel:"vk2SBPanel",sidebarContentPanel:"vk2SBContentPanel",sidebarBodyPanel:"vk2SidebarBodyPanel",sidebarHeaderPanel:"vk2SBHeaderPanel",sidebarHeaderLabel:"vk2SBHeaderLabel",sidebarHeaderClose:"vk2SBClose",sidebarIcon:"vk2SidebarIcon",sidebarControlBtn:"vk2SBControlBtn",sidebarToolActive:"vk2ToolActivate"},_sidebarController:null,_updateSettings:function(a){for(var b in a)this._settings[b]=a[b]},_loadHtmlElements:function(a){var b=$("#"+this._settings.sidebarPanel),
b=$("<div/>",{id:this._settings.sidebarContentPanel,"class":this._settings.sidebarContentPanel}).appendTo(b),c=$("<div/>",{id:this._settings.sidebarHeaderPanel,"class":this._settings.sidebarHeaderPanel}).appendTo(b);$("<div/>",{id:this._settings.sidebarHeaderLabel,"class":this._settings.sidebarHeaderLabel}).appendTo(c);$("<div/>",{id:this._settings.sidebarHeaderClose,"class":this._settings.sidebarHeaderClose+" "+this._settings.sidebarIcon}).appendTo(c);b=$("<div/>",{id:this._settings.sidebarBodyPanel,
"class":this._settings.sidebarBodyPanel}).appendTo(b);for(c=0;c<a.length;c++)$("<div/>",{id:a[c],"class":a[c]}).appendTo(b)},_loadSidebarController:function(a){var b=$("#"+this._settings.sidebarPanel).css("width");this._sidebarController=new VK2.Controller.SidebarController({speed:300,panelLocation:"right",sidebarPanel:this._settings.sidebarPanel,sidebarHeaderLabel:this._settings.sidebarHeaderLabel,sidebarPanelWidth:b,sidebarCloseBtn:this._settings.sidebarHeaderClose},a)},_createControlElement:function(a,
b){$("<span/>",{"class":this._settings.sidebarIcon}).appendTo($("<a/>",{id:a,"class":a+" "+this._settings.sidebarControlBtn,value:b}).appendTo($("#"+this._settings.sidebarPanel)))},_appendControlPanel:function(a){$("#"+a).appendTo($("#"+this._settings.sidebarBodyPanel));$("#"+a).addClass(this._settings.sidebarToolActive)},initialize:function(a,b,c){this._updateSettings(a);this._loadHtmlElements(c);this._loadSidebarController(b)},appendControl:function(a,b,c){this._createControlElement(a,b);this._appendControlPanel(b);
this._sidebarController._registerControl(a,c)},appendSlimControl:function(a,b){this._createControlElement(a,"");this._sidebarController._registerSlimControl(a,b)},open:function(a){this._sidebarController._slideOut()},close:function(a){this._sidebarController._deactivateControls();this._sidebarController._slideIn()}});VK2.Tools.LoadingScreen=VK2.Class({_settings:{status:0},_createLoadingScreen:function(){var a=$("<div/>",{html:"Bitte warten Sie. Ihre raumzeitliche Reise wird vorbereitet.",id:"loadingScreen","class":"loadingScreen"}).appendTo("body");$("<br/>").appendTo(a);$("<span/>",{html:this._settings.status+" % geladen.",id:"loadingStatus"}).appendTo(a)},_updateLoadingScreen:function(a){100>a&&$("#loadingStatus").text(a+" % geladen.")},_updateSettings:function(a){for(var b in a)this._settings[b]=a[b]},initialize:function(a){this._updateSettings(a);
this._createLoadingScreen()},setStatus:function(a){this._settings.status=a;this._updateLoadingScreen(a)},clearLoadingScreen:function(){$("#loadingScreen").remove()}});var initVkViewerSlim=function(a){VK2.Utils.setGenericOpenLayersPropertys("vkviewer/proxy/?url=");a=VK2.Utils.loadBaseMap(a,initConfiguration.mapOptions,initConfiguration.mapnikOptions);addEvents();(new VK2.Utils.AppLoader({map:a,mapController:VK2.Controller.MapController,timeParameter:initConfiguration.timeParameter})).loadSlimApp();return!0},initVkViewerFat=function(a){VK2.Utils.setGenericOpenLayersPropertys("vkviewer/proxy/?url=");a=VK2.Utils.loadBaseMap(a,initConfiguration.mapOptions,initConfiguration.mapnikOptions);
addEvents();(new VK2.Utils.AppLoader({map:a,mapController:VK2.Controller.MapController,timeParameter:initConfiguration.timeParameter})).loadFatApp();return!0},addEvents=function(){document.getElementById("vk2UserToolsLogin")&&$("#vk2UserToolsLogin").fancybox({width:"350px",height:"100%",type:"iframe"});VK2.Utils.initializeFancyboxForClass("vk2FooterLinks");document.getElementById("vk2WelcomePage")&&$("#vk2WelcomePage").fancybox({type:"iframe",padding:0}).click();loadDropDownBehavor()},loadDropDownBehavor=
function(){function a(){c&&(c.style.visibility="hidden")}var b=0,c=0;document.onclick=a;null!=document.getElementById("vk2GeneralLink")&&($(document.getElementById("vk2GeneralLink")).hover(function(){b&&(window.clearTimeout(b),b=null);c&&(c.style.visibility="hidden");c=document.getElementById("vk2GeneralDropDownContent");c.style.visibility="visible"},function(){b=window.setTimeout(a,500)}),$(document.getElementById("vk2GeneralDropDownContent")).hover(function(){b&&(window.clearTimeout(b),b=null)},
function(){b=window.setTimeout(a,500)}))};
